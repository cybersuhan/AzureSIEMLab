<h1>Azure Sentinel Lab - Security Information and Event Management (SIEM) in Azure</h1>

<h2>Contents</h2>
<ol>
 <li><a href="https://github.com/cybersuhan/AzureSIEMLab/edit/main/README.md#description">Description</a></li>
 <li><a href="https://github.com/cybersuhan/AzureSIEMLab/edit/main/README.md#platforms-tools-and-languages-used">Platforms, Tools and Languages</a></li>
 <li><a href="https://github.com/cybersuhan/AzureSIEMLab/edit/main/README.md#skills-highlighted">Skills Highlighted</a></li>
 <li><a href="https://github.com/cybersuhan/AzureSIEMLab/edit/main/README.md#before-starting">Before Starting</a></li>
 <li><a href="https://github.com/cybersuhan/AzureSIEMLab/edit/main/README.md#quick-walkthrough">Quick Walkthrough</a></li>
 <li><a href="https://github.com/cybersuhan/AzureSIEMLab/edit/main/README.md#step-by-step-walkthrough">Step-by-step Walkthrough</a></li>
</ol>

<h2>Description</h2>
In this cybersecurity project, I designed and implemented a SIEM (Security Information and Event Management) solution using Microsoft Sentinel in the Azure cloud platform. The primary objectives of this lab were to:<br /><br />
<b>Set up an Azure Environment:</b> I created a free Azure account and established a Virtual Machine (VM) acting as a honeypot for this lab. The VM was configured to be discoverable over the internet by turning off the firewall settings.<br /><br />
<b>Geolocation-based Threat Monitoring:</b> To gather geographical information from failed login attempts to the Virtual Machine, I used a combination of PowerShell script and the IPGeolocation API. This allowed me to track the source locations of potential attackers.<br /><br />
<b>Custom Log Collection and Analysis:</b> A custom PowerShell script was developed to extract failed login attempts from the event viewer on the Virtual Machine and export them to a log file in the "C:\ProgramData" directory.<br /><br />
<b>Microsoft Sentinel Integration:</b> I connected Microsoft Sentinel to the Log Analytics Workspace to leverage its powerful capabilities for real-time log analysis and visualization.<br /><br />
<b>Visualizing Attack Data:</b> Using Microsoft Sentinel Workbooks, I created a custom workbook that featured a world map plotting the failed login attempts' geolocation data. The map was dynamically updated as new data was collected.<br /><br />

<h2>Platforms, Tools and Languages used</h2>

- Azure
- IPGeolocation API
- Powershell
- Microsoft Sentinel

<h2>Skills Highlighted</h2>
<b>Azure Cloud Platform:</b> I demonstrated proficiency in setting up an Azure environment, creating Virtual Machines, and managing resources within a resource group.<br />
<b>PowerShell Scripting:</b> Developing the custom log exporter using PowerShell showcased my scripting skills for log data extraction and API integration.<br />
<b>SIEM Integration:</b> I illustrated my ability to integrate and configure Microsoft Sentinel with Azure services, such as Log Analytics Workspace and Virtual Machines.<br />
<b>Log Collection and Analysis:</b> The successful setup and analysis of custom logs in the Log Analytics Workspace highlighted my expertise in log management and analysis.<br />
<b>Data Visualization:</b> Creating a dynamic world map using Microsoft Sentinel Workbooks showcased my data visualization capabilities for cybersecurity monitoring.<br />

<h2>Before Starting</h2>
I set up my Azure account, taking advantage of the $200 free Azure credits for new users, which provided sufficient resources for this lab. 

<h2>Quick Walkthrough</h2>

<h3>Virtual Machine Setup</h3>
- I created a Virtual Machine (VM) in Azure, naming it "HoneyPot-VirtualMachine" and placing it in the "HoneyPotLab" resource group. The VM was located in the "East US" region.
The VM used the "Windows 10 Pro" image with the "Standard_B1s" size (1 vCPU, 1GiB memory).<br />
- I configured RDP (Remote Desktop Protocol) access to the VM, making it publicly discoverable.<br />

<h3>Log Analytics Workspace (LAW) Configuration</h3>
- I created a Log Analytics Workspace named "LAWHoneyPot" in the "HoneyPotLab" resource group to collect and store log data.<br />
- I enabled log data collection from the VM to the LAW by configuring data collection settings in the Security Center.<br />
- I connected the VM to the LAW to send log data from the VM's event viewer to the workspace.<br />

<h3>Custom Log Exporter</h3>
- I developed a custom PowerShell script that extracted failed login attempts from the VM's event logs and retrieved the corresponding IP addresses.<br />
- Using the IPGeolocation API, I obtained geographic information based on the IP addresses and exported the data to a log file in the VM's "C:\ProgramData" directory.<br />

<h3>Custom Log in Log Analytics Workspace</h3>
- In the LAW, I created a custom log table named "FAILED_RDP_GEO_CL" to store the geographic data obtained from the PowerShell script.<br />
- I uploaded a sample log file generated by the script to validate the custom log format.<br />

<h3>Setting up a Map in Microsoft Sentinel</h3>
- I accessed Microsoft Sentinel from the Azure portal and created a new workbook named "Failed RDP World Map."<br />
- I wrote a query in the workbook to extract relevant columns, including timestamp, country, state, username, destination, longitude, and latitude.<br />
- I configured the visualization option to display the data on a world map, plotting the latitude and longitude data and labeling it by country.<br />

<h3>Monitoring Attack Data</h3>
- After starting the PowerShell script, the custom log exporter collected and uploaded failed login attempts and geolocation data to the Log Analytics Workspace.<br />
- Microsoft Sentinel continuously analyzed the data and displayed real-time information on the world map in the "Failed RDP World Map" workbook.<br />


<h2>Step-by-step Walkthrough</h2>
<h4>Creating a Virtual Machine</h4>
This is the machine that is going to be exposed on the internet. Different people from all around the world will attempt to attack this machine and try to login to this machine. Essentially, This machine acts as a <b>Honeypot</b> for this lab. 
<br />
<br />

Search "Virtual Machine" on the search bar and click "Virtual Machines" under "Services"
<br/>
<img src="https://i.imgur.com/06SyeQK.png" height="80%" width="80%" alt="Select Virtual Machines"/>
<br />
<img src="https://i.imgur.com/0UCxxwh.png" height="80%" width="80%" alt="Virtual Machines Page"/>
<br />
Create a new Azure Virtual Machine:<br />
<img src="https://i.imgur.com/oEE75SH.png" height="80%" width="80%" alt="Create a New Virtual Machine Button"/>
<br />
Create a new Resource Group:  <br/>
<img src="https://i.imgur.com/dHDRpPb.png" height="80%" width="80%" alt="Create a New Resource Group"/>
<br />
A resource group in Azure is a logical grouping of resources that usually share the same lifespan. Everything in this lab project are going to be in the same resource group. 

I changed the following information on the "Create Virtual Machine" page for the lab:<br />
<b>Resource Group:</b> Create New >> "HoneyPotLab"<br />
<b>Virtual Machine Name:</b> "HoneyPot-VirtualMachine"<br />
<b>Region:</b> "(US) East US" -> <i>This is the location of the data center that will be used for this Virtual Machine</i><br />
<b>Image:</b> "Windows 10 Pro, version 22H2 - x64 Gen2"<br />
<b>Size:</b> "Standard_B1s - 1 vcpu, 1GiB memory"<br /><br />

<b>Username:</b> "cybersuhanlab"<br />
<b>Password: </b> "<i>mypassword</i>"<br />
<b>Confirm Password: </b><i>Repeat Password</i><br />

<i>I will be using the above username and password to log in to the virtual machine later.<i/><br /><br />

<b>Public Inbound Ports:</b> "Allow selected ports" -> <i>Default</i> <br />
<b>Selected Inbound ports:</b> " RDP(3389) -> <i>Default</i><br />
<b><i>Tick the Licencing rights note</i></b><br /><br />
<img src="https://i.imgur.com/a2ZdWqQ.png" height="80%" width="80%" alt="VM Settings 1"/><br />
<img src="https://i.imgur.com/bGMlut3.png" height="80%" width="80%" alt="VM Settings 2"/><br />
<br />
Next, I go to Disks settings for the Virtual Machine by clicking on "Next: Diks >"
<img src="https://i.imgur.com/Y1MQvA6.png" height="80%" width="80%" alt="Disk Settings"/><br />
I leave the Disk settings as default for this lab and Click on "Next: Networking >"<br />

Create New Network Security Group: <br />

At this point, I want my firewall to be open to everything to the public internet. For this, I have to create a firewall inbound rule that allows everything into the VM. For this, I create a new network security group and set open inbound rules. The point here is that I want to make my lab machine very discoverable by any means necessary. I dont want my VM to drop any traffic. To do this, I take the following steps:

In the Networking settings, I create a new Network Security Group: <br />
<img src="https://i.imgur.com/JIxAbvl.png" height="80%" width="80%" alt="VM Networking Page"/><br />

In the network security group page, I remove the existing inbound firewall rules: <br />
<img src="https://i.imgur.com/9c4DXnW.png" height="80%" width="80%" alt="Remove Inbound Rules"/><br />

Then, I add a new inbound rule with the following configuration: <br />

<b>Source: </b> "Any"<br />
<b>Source Port Ranges: </b> "*"<br />
<b>Destination: </b>"Any"<br />
<b>Service: </b>"Custom"<br />
<b>Destination port ranges: </b>"*"<br />
<b>Protocol: </b>"Any"<br />
<b>Action: </b>"Allow"<br />
<b>Priority: </b>"100" -> <i>Set to lower priority</i><br />
<b>Name: </b>"ANY_INBOUND_CAUTION"<br />

Then I click Add to add the inbound rule.<br />
<img src="https://i.imgur.com/tAIsWvn.png" height="80%" width="80%" alt="Add Inbound Rule"/><br />
<img src="https://i.imgur.com/IcKkLDF.png" height="80%" width="80%" alt="Update Inbound Rule"/><br />
<img src="https://i.imgur.com/mE2xi5w.png" height="80%" width="80%" alt="Confirm Rule"/><br />

I click OK to save my new network configuration group.<br /><br />

Then for the last step of creating a virtual machine, I click "Review and Create"<br />
<img src="https://i.imgur.com/B6rEVgK.png" height="80%" width="80%" alt="Review and Create"/><br />

Finally, I get to the Review Page where I press "Create" to Deploy my new Virtual Machine<br />
<img src="https://i.imgur.com/RIiz3sq.png" height="80%" width="80%" alt="Create VM"/><br />

<h4>Creating a new Log Analytics Workspace</h4>

The purpose of a Log Analytics Workspace is to inject logs from the Virtual Machine, specifically the Windows event logs. I will also create a custom log that contains geographic information so that I can discover where the attacks are coming from. The log analytics workspaces are where the logs are stored. Then, Azure Sentinel will connect to this workspace to display the geographical data on the map. 

To create a log analytics workspace, I take the following steps: <br /><br />

Open Log Analytics Page: <br />
<img src="https://i.imgur.com/9j3WXa2.png" height="80%" width="80%" alt="Search Log Analytics"/><br />

Click on Create: <br />
<img src="https://i.imgur.com/F1dDRDk.png" height="80%" width="80%" alt="Create Log Analytics"/><br />

In the Create Log Analytics Workspace page, I select the <b>"HoneyPotLab"</b> as the resource group as it is the one I created in the previous step. For the Instance name, I name it <b>"LAWHoneyPot"</b> as Log Analytics Workspace HoneyPot. Then I press "Review + Create". On the next page, I review the configuration I set and press create. <br />

<img src="https://i.imgur.com/gSgyLJP.png" height="80%" width="80%" alt="Log Analytics Config"/><br />
<img src="https://i.imgur.com/UgbNaIs.png" height="80%" width="80%" alt="Review and Create Log Analytics"/><br /><br />

Now, I need to enable the ability to gather log information from the Virtual Machine into the Log Analytics Workspace. For this, I go to the Security Center.<br />
<img src="https://i.imgur.com/aG5rQfU.png" height="80%" width="80%" alt="Review and Create Log Analytics"/><br /><br />

In the Security Center, I find "Environment Settings" on the left-hand panel and click on it.<br />
<img src="https://i.imgur.com/MLD95mu.png" height="80%" width="80%" alt="Click Environment Settings"/><br /><br />

Next, I click the dropdown of my Azure Subscription and find my Log Analytics Workspace (LAW). I click on Edit settings for my LAW:<br />
<img src="https://i.imgur.com/lC36iJP.png" height="80%" width="80%" alt="Edit LAW settings"/><br /><br />

I toggle the "SQL Server on Machines" to "Off" and Save the configuration:<br /> 
<img src="https://i.imgur.com/93Q3hfW.png" height="80%" width="80%" alt="Edit LAW settings"/><br /><br />

Next, I click on "Data Collection" on the left-hand panel. I select "All Events" from the list and save the configuration:<br />
<img src="https://i.imgur.com/8Qyugqn.png" height="80%" width="80%" alt="Data Collection"/><br /><br />

I need to connect the Log Analytics Workspace to the Virtual Machine. To do this I go back to the Log Analytics Workspace Page and click on my LAW:<br />
<img src="https://i.imgur.com/OpseDSA.png" height="80%" width="80%" alt="Data Collection"/><br /><br />

Then I find "Azure Virtual Machine" under "Connect Data Source" or "Virtual Machines" on the left-hand side panel:<br />
<img src="https://i.imgur.com/SvNChjo.png" height="80%" width="80%" alt="Connect Data Source"/><br /><br />

I find my Virtual Machine created in the first step and click on it. <br />
<img src="https://i.imgur.com/Xz4UU4F.png" height="80%" width="80%" alt="Select VM"/><br /><br />

On the next page, I press "Connect" to connect my Virtual Machine to my LAW:<br />
<img src="https://i.imgur.com/UnsFsnj.png" height="80%" width="80%" alt="Connect VM"/><br /><br />


<h4>Setting up Microsoft Sentinal</h4>
Microsoft Sentinal is the SIEM that I will use to visualize the attack data. <br /><br />

To Set Up Microsoft Sentinal, I search Sentinal on the Azure Portal Homepage and Click on it.<br />
<img src="https://i.imgur.com/NHU3cuw.png" height="80%" width="80%" alt="Search Sentinal"/><br /><br />

Next, I click on "Create Microsoft Sentinal."<br />
<img src="https://i.imgur.com/aRHbV3Q.png" height="80%" width="80%" alt="Search Sentinal"/><br /><br />

Then, I select the LAW that I created in the previous step and add it.<br />
<img src="https://i.imgur.com/LyOPwux.png" height="80%" width="80%" alt="Search Sentinal"/><br /><br />

At this point, Microsoft Sentinel is connected to our Log Analytics Workspace. 

<h4>Starting Azure Virtual Machine through Remote Connection</h4>
After I completed connecting Sentinel to the LAW, Now I establish a Remote Connection from my Machine to the Virtual Machine that I created in Azure. For this, I need the IP address of the Virtual Machine. To get the IP Address, I go to my Azure Portal and find "Virtual Machines" and click on it. The portal takes me to the list of my virtual machine where I select my HoneyPotLab Virtual Machine:<br /> 
<img src="https://i.imgur.com/qWEY87F.png" height="80%" width="80%" alt="Find Virtual Machine"/><br /><br />
<img src="https://i.imgur.com/IGpoNQN.png" height="80%" width="80%" alt="Select Virtual Machine"/><br /><br />

Next, I can see the <b>Public IP Address</b> of my Virtual Machine:<br />
<img src="https://i.imgur.com/88YComR.png" height="80%" width="80%" alt="VM IP Address"/><br /><br />

I copy the Public IP Address and on my device, I open <b>Remote Desktop Connection</b>. I paste the VM IP address and click "Connect". In the next window, I type the username and password that I set while configuring the VM and click "OK". If the credentials are correct, I get logged in to the VM in the Remote Desktop Connection Window. 
<img src="https://i.imgur.com/aeBAZxp.png" height="80%" width="80%" alt="RDC Window"/><br /><br />
<img src="https://i.imgur.com/SiVFr2r.png" height="80%" width="80%" alt="RDC Window Credentials"/><br /><br />

The Virtual Machine IP is shown on the top of the Remote Desktop Connection Window.
<img src="https://i.imgur.com/Tuf7IkD.png" height="80%" width="80%" alt="VM IP Address in RDC"/><br /><br />

<h4>Update Firewall settings in the Virtual Machine</h4>

For the sake of this lab, I want to make the virtual machine discoverable so that anyone over the internet can find the device and try to brute force and log in to the machine. For that, I need to update my firewall settings. I have two choices at this point. I can either allow ICMP inbound or turn the firewall off. For this lab, I choose to turn my firewall off and try to ping the virtual machine from my computer and I get a successful ping. <br />

Toggling VM Firewall Domain Profile off<br />
<img src="https://i.imgur.com/20b6W8r.png" height="80%" width="80%" alt="Firewall Domain Off"/><br /><br />
Toggling VM Firewall Private Profile off<br />
<img src="https://i.imgur.com/DqbqSRW.png" height="80%" width="80%" alt="Firewall Private Off"/><br /><br />
Toggling VM Firewall Public Profile off<br />
<img src="https://i.imgur.com/UZqhNbO.png" height="80%" width="80%" alt="Firewall Public Off"/><br /><br />
Pinging the VM from my computer<br />
<img src="https://i.imgur.com/yTRyLt6.png" height="80%" width="80%" alt="Pinging the VM"/><br /><br />

<h4>Custom Log Exporter</h4>

Next, I want a security log exporter made Powershell that will loop through the Event Log and grabs all the events in which users fail to log in, and grabs the IP Address. With the IP Address, I can get geolocation ta from ipgeolocation.io. The Exporter program exports failed login attempts from the event viewer to a file in "C:\ProgramData" in the Virtual Machine. The following screenshot is what the file looks like after 2 minutes of running the script:

<img src="https://i.imgur.com/2CWLMpM.png" height="80%" width="80%" alt="Custom Log"/><br /><br />

<h4>Custom Log in Log Analytics Workspace</h4>

In my Azure Portal, I go to my Log Analytics Workspace (LAWHoneyPot) and Select Tables:<br />
<img src="https://i.imgur.com/rsZTZ8H.png" height="80%" width="80%" alt="Custom Log"/><br /><br />

I create a New Custom Log Table (MMA Based):<br />
<img src="https://i.imgur.com/3FhrFy1.png" height="80%" width="80%" alt="Custom Log"/><br /><br />

Then I copy the log file that the script output in previously and upload it as a sample log file: <br />
<img src="https://i.imgur.com/f3GVYG9.png" height="80%" width="80%" alt="Custom Log"/><br /><br />

Next, I check the if the file is correct and the delimitation is right and I click <i>Next</i><br />
<img src="https://i.imgur.com/VXUTWLb.png" height="80%" width="80%" alt="Custom Log"/><br /><br />

For the custom log name, I type in "FAILED_RDP_GEO" and click next. In Azure, the custom table can be queried as "FAILED_RDP_GEO_CL"<br />
<img src="https://i.imgur.com/GxkEZNc.png" height="80%" width="80%" alt="Custom Log"/><br /><br />

In the VM, the custom log file is saved in "C:\ProgramData\failed_rdp.log", which is what I will write in the collection path. <br />
<img src="https://i.imgur.com/0pvt6TL.png" height="80%" width="80%" alt="Custom Log"/><br /><br />

Next, I wait for about an hour before going to the Azure portal to my Log Analytics Workspace and click "Logs". I run the FAILED_RDP_GEO_CL query and get the data from the log file: <br />
<img src="https://i.imgur.com/zfaW6aF.png" height="80%" width="80%" alt="Custom Log"/><br /><br />

<b>At this point, I have the geographical data coming into the Log Analytics workspace as raw data in a custom table.</b>

<h4>Setting up a map in Microsoft Sentinal</h4>

Now that I am getting data in real-time, I want to set up Sentinal and plot the failed login attempts' location on a map. To do that, I take the following steps:<br /><br />

I go to Azure Portal and into Microsoft Sentinal. There, I click "Workbooks" from the left-hand panel and then click "Add Workbook"<br />

<img src="https://i.imgur.com/6NdoM9i.png" height="80%" width="80%" alt="Sentinal Workbooks"/><br /><br />

I add a query in the workbook and edit the query to extract columns including timestamp, country, state, username, destination, longitude, and latitude.<br />
<img src="https://i.imgur.com/9Gj87su.png" height="80%" width="80%" alt="Sentinal Workbooks"/><br /><br />
<img src="https://i.imgur.com/Z7EHsHC.png" height="80%" width="80%" alt="Sentinal Workbooks"/><br /><br />
<i>I had stopped the Powershell script but while it was running, there were 26 failed attempts to log in from the Netherlands already.</i><br /><br />

I set the visualization option to "Map":<br />

<img src="https://i.imgur.com/onLp0sO.png" height="80%" width="80%" alt="Sentinal Workbooks"/><br /><br />

In the map settings, I set the Layout Settings -> Location info using to "Latitude/Longitude". I also set Metric Settings -> Metric label to "country" and Metric Value to "event_count". So, I am plotting the map according to latitude and longitude data and labeling it by country.:<br />

<img src="https://i.imgur.com/EGdNQo1.png" height="80%" width="80%" alt="Sentinal Workbooks"/><br />
<img src="https://i.imgur.com/r2szDa7.png" height="80%" width="80%" alt="Sentinal Workbooks"/><br /><br />

I save the workbook as "Failed RDP World Map":<br />
<img src="https://i.imgur.com/K5WSZGd.png" height="80%" width="80%" alt="Sentinal Workbooks"/><br /><br />

<b>Next, I start the Powershell Script again. With the free account of ipgeolocation.io, I can get 1000 entries per day which is not much but is fine for this project. </b><br /><br />


After some time, I get a bunch of failed login attempts in the Virtual Machine. (Most are from the Netherlands)<br />

<img src="https://i.imgur.com/D085smj.png" height="80%" width="80%" alt="Sentinal Workbooks"/><br /><br />


<h4>Attack Map after a period of time</h4>

<b><i>I will let the script run in my Virtual Machine for some time and will see how the map updates for some time. I will post the screenshots in this section.</i></b><br /><br />

<b>After 1 Hour</b><br />
<img src="https://i.imgur.com/iqbPsLJ.png" height="80%" width="80%" alt="Sentinal Workbooks"/><br /><br />
<i>The VM already has 466 failed login attempts from the Netherlands, 4 from Russia, 2 from the US, and 1 attempt from Singapore in 1 hour.</i>


<h3>After 10 Hours</h3><br />
<img src="https://i.imgur.com/VptC6yp.png" height="80%" width="80%" alt="Sentinal Workbooks"/><br /><br />





<!--
 ```diff
- text in red
+ text in green
! text in orange
# text in gray
@@ text in purple (and bold)@@
```
--!>
